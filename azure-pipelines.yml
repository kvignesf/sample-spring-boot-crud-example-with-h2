trigger:
  - main

pool:
  name: azurevm

steps:
# Step 1: Secret Scan using Gitleaks
- script: |
    echo "ğŸ” Installing Gitleaks..."
    curl -sSL https://github.com/gitleaks/gitleaks/releases/download/v8.18.2/gitleaks_8.18.2_linux_x64.tar.gz -o gitleaks.tar.gz
    tar -xzf gitleaks.tar.gz
    sudo mv gitleaks /usr/local/bin/gitleaks
    gitleaks version

    echo "ğŸ” Running Gitleaks secret scan..."
    gitleaks detect --source=. --exit-code 1 --report-format sarif --report-path=gitleaks-report.sarif || echo "âš ï¸ Secrets found, but continuing..."
    
    echo "ğŸ“¦ Moving Gitleaks report to artifact staging..."
    mkdir -p $(Build.ArtifactStagingDirectory)/gitleaks
    mv gitleaks-report.sarif $(Build.ArtifactStagingDirectory)/gitleaks/
  displayName: 'ğŸ” Gitleaks Secret Scan'
  failOnStderr: false
  continueOnError: true

# Step 2: Trivy scan (fail on HIGH/CRITICAL)
- script: |
    echo "ğŸ›  Installing Trivy..."
    sudo apt-get update
    sudo apt-get install -y wget apt-transport-https gnupg lsb-release
    wget -qO - https://aquasecurity.github.io/trivy-repo/deb/public.key | sudo apt-key add -
    echo "deb https://aquasecurity.github.io/trivy-repo/deb $(lsb_release -cs) main" | sudo tee /etc/apt/sources.list.d/trivy.list
    sudo apt-get update && sudo apt-get install -y trivy

    echo "ğŸ›¡ Running Trivy vulnerability scan..."
    trivy fs . --exit-code 1 --severity HIGH,CRITICAL --format table
  displayName: 'ğŸ›¡ Trivy Scan for Vulnerabilities'
  failOnStderr: true
  continueOnError: false

# Step 3: Build the app using Maven
- task: Maven@3
  inputs:
    mavenPomFile: 'pom.xml'
    mavenOptions: '-Xmx3072m'
    javaHomeOption: 'JDKVersion'
    jdkVersionOption: '1.11'
    jdkArchitectureOption: 'x64'
    mavenAuthenticateFeed: true
    publishJUnitResults: true
    testResultsFiles: '**/surefire-reports/TEST-*.xml'
    goals: 'package'
  displayName: 'âš™ï¸ Build with Maven'

# Step 4: Copy files to artifact staging
- task: CopyFiles@2
  inputs:
    Contents: '**'
    TargetFolder: '$(Build.ArtifactStagingDirectory)'
  displayName: 'ğŸ“¦ Copy files to artifact staging'

# Step 5: Publish artifacts
- task: PublishBuildArtifacts@1
  inputs:
    PathtoPublish: '$(Build.ArtifactStagingDirectory)'
    ArtifactName: 'Shopping'
    publishLocation: 'Container'
  displayName: 'ğŸš€ Publish Artifacts'
