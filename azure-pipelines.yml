trigger:
- main

pool:
  name: azurevm

steps:
# Step 1: Secret Scan using Gitleaks
- script: |
    echo "üîê Running Gitleaks secret scan..."
    gitleaks detect --source=. --exit-code 1 --report-format sarif --report-path=gitleaks-report.sarif
  displayName: 'üîç Gitleaks Secret Scan'
  failOnStderr: true
  continueOnError: false  # Fail pipeline if secrets are found

# Step 2: Trivy scan (only fail on HIGH/CRITICAL)
- script: |
    echo "üîê Running Trivy vulnerability scan..."
    trivy fs . --exit-code 1 --severity HIGH,CRITICAL --format table
  displayName: 'üõ° Trivy Scan for Vulnerabilities'
  failOnStderr: true
  continueOnError: false  # Fail pipeline on HIGH/CRITICAL

# Step 3: Build the app using Maven
- task: Maven@3
  inputs:
    mavenPomFile: 'pom.xml'
    mavenOptions: '-Xmx3072m'
    javaHomeOption: 'JDKVersion'
    jdkVersionOption: '1.11'
    jdkArchitectureOption: 'x64'
    mavenAuthenticateFeed: true
    publishJUnitResults: true
    testResultsFiles: '**/surefire-reports/TEST-*.xml'
    goals: 'package'

# Step 4: Copy files to artifact staging
- task: CopyFiles@2
  inputs:
    Contents: '**'
    TargetFolder: '$(Build.ArtifactStagingDirectory)'

# Step 5: Publish artifacts
- task: PublishBuildArtifacts@1
  inputs:
    PathtoPublish: '$(Build.ArtifactStagingDirectory)'
    ArtifactName: 'Shopping'
    publishLocation: 'Container'
